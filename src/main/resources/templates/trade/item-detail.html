<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title th:text="|장사의 신 - ${item.name}|"></title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link th:href="@{/static/css/style.css}" rel="stylesheet" />
</head>
<body>
	<div class="container py-3">
		<!-- chart view -->
		<div style="position: relative; height: 35vh;" class="mb-2">
			<canvas id="chart" th:data-target="${item.id}"></canvas>
		</div>

		<!-- item & purchase view -->
		<div class="row ">
			<!-- item view -->
			<div class="col-12 col-md-6" id="itemView" th:data-id="${item.id}">
				<div class="card">
					<div
						class="card-header d-flex justify-content-between align-items-end">
						<div>
							<span th:text="${item.name}" class="fs-5"></span> <span
								class="badge bg-secondary" th:text="${item.type.name}"></span> <span
								id="trendBadge"
								th:styleappend="${item.trend}? '' : 'display:none'"
								class="badge bg-primary">유행중</span>
						</div>
						<div class="fs-7">
							<span id="currentPrice"
								th:text="${#numbers.formatCurrency(item.price.current)}"></span>
							/ <span>재고 :</span> <span id="currentStock"
								th:text="${#numbers.formatInteger(item.stock, 0, 'COMMA')}"></span>
							<span>개</span>
						</div>
					</div>
					<ul class="list-group list-group-flush" id="priceLog">
						<li
							class="list-group-item d-flex justify-content-between py-1 fs-6"
							th:each="log : ${priceLogs}">
							<div>
								<span th:text="${#numbers.formatCurrency(log.previousPrice)}"></span>
								<span>▶</span> <span
									th:text="${#numbers.formatCurrency(log.updatedPrice)}"></span>
							</div>
							<div class="fs-7">
								<span class=" text-secondary"
									th:text="${#temporals.format(log.updatedAt, 'HH:mm:ss')}"></span>
							</div>
						</li>
					</ul>
				</div>
			</div>


			<div class="col-12 col-md-6">
				<!-- 구매 / 판매 뷰-->
				<div class="card" th:if="${#authentication}">
					<div class="card-header">
						<ul class="nav nav-tabs card-header-tabs">
							<li class="nav-item"><a class="nav-link active"
								aria-current="true" href="#" data-bs-toggle="tab"
								data-bs-target="#purchase-tab-pane">구매</a></li>
							<li class="nav-item"><a class="nav-link" href="#"
								data-bs-toggle="tab" data-bs-target="#sales-tab-pane">판매</a></li>
						</ul>
					</div>
					<div class="card-body">
						<div class="tab-content">
							<div class="tab-pane fade show active" id="purchase-tab-pane"
								role="tabpanel" tabindex="0">
								<form th:action="@{/trade/{id}/purchase(id=${item.id})}"
									method="post">
									<div class="mb-2">
										<input type="hidden" name="itemId" th:value="${item.id}" /> <input
											type="number" class="form-control text-end" name="quantity"
											id="quantity" th:data-current-price="${item.price.current}"
											th:data-balance="${authenticatedAccount.balance}"
											placeholder="구매 희망 수량" value="0" min="1" max="100" />
									</div>
									<div
										class="mb-2 gap-2 text-truncate
										d-flex justify-content-end fs-7 text-secondary">
										<span
											th:text="
										${#numbers.formatCurrency(authenticatedAccount.balance)}"></span>
										- <span id="price">&#8361;0</span> = <span id="result"
											th:text="
										${#numbers.formatCurrency(authenticatedAccount.balance)}"></span>
									</div>
									<div class="d-flex justify-content-end">
										<button type="submit" class="btn btn-dark btn-sm">구매
											신청</button>
									</div>
								</form>

							</div>
							<div class="tab-pane fade" id="sales-tab-pane" role="tabpanel"
								tabindex="0">
								<h5 class="card-title">구매</h5>
								<p class="card-text">With supporting text below as a natural
									lead-in to additional content.</p>
							</div>
						</div>
					</div>
				</div>

				<!-- 로그인 유도 뷰 -->
				<div th:unless="${#authentication}"
					class="d-flex justify-content-center align-items-center"
					style="height: 100%;">
					<a th:href="@{/trade/{id}/callback(id=${item.id})}">로그인이 필요합니다</a>
				</div>
			</div>
		</div>

	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
	
		/*  최신 아이템 상태 받아와서 뷰 변경 시키는 처리 */
		function updateLatestDataSet() {
			const id =document.querySelector("#itemView").dataset.id;
			fetch("/trade/api/latest/"+id, {
				
			}).then(function(response) {
				return response.json();
			}).then(function(obj) {
				// 트렌드 배지 처리
				document.querySelector("#trendBadge").style.display 
													= obj.tradeItem.trend ? '' : 'none';
				
				document.querySelector("#currentPrice").innerHTML = "&#8361;"+
													obj.tradeItem.price.current.toLocaleString();
				document.querySelector("#currentStock").innerHTML = obj.tradeItem.stock.toLocaleString();
				
				
				document.querySelector("#priceLog").innerHTML =  "";
				
				const lis = obj.latestLog.map(e => {
					const li = document.createElement("li");
						li.className = "list-group-item d-flex justify-content-between py-1 fs-6";
					const div1 = document.createElement("div");	
						const span11 = document.createElement("span");
							span11.innerHTML = "&#8361;"+e.previousPrice.toLocaleString();
						const span12 = 	document.createElement("span");
							span12.innerHTML = " ▶ ";
						const span13 = 	document.createElement("span");
							span13.innerHTML = "&#8361;"+e.updatedPrice.toLocaleString();
						div1.append(span11, span12, span13);
					const div2 = document.createElement("div");
						div2.className="fs-7 text-secondary";
						const span21 = 	document.createElement("span");
						span21.innerHTML = e.updatedAt.split("T")[1].substr(0, 8);
						div2.append(span21);
					li.append(div1, div2);	
					return li;
				});
				document.querySelector("#priceLog").append(...lis);
			});
		}
		
		/* 최신 가격변동 로그 가지고와서 차트 그리기 */
		
		let char = null;
		
		
		function drawChart() {
			const ctx = document.getElementById("chart");
			const target = ctx.dataset.target;
			fetch("/trade/api/pricelog/" + target, {

			}).then(function(response) {
				return response.json();
			}).then(function(obj) {
				
				
				new Chart(ctx, {
					type : "line",
					data : {
						labels : obj.labels,
							datasets : [ {
								label : '가격변동 그래프',
								data : obj.data,
								tension : 0.1

							} ]
						},
						options : {
							maintainAspectRatio : false,
							plugins : {
								legend : {
									display : false
								}
							},
							scales : {
								x : {
									display : false
								}
							}
						}
					});
				});
			}

	
		/* 구매 개수 변동에 따른 스크립트 처리 */
		document.querySelector("#quantity")?.addEventListener("input",function(e) {
			const value = e.target.value * 1;
			const current = e.target.dataset.currentPrice * 1;
			const balance = e.target.dataset.balance * 1;
			// console.log(value, current, balance);
			const $price = document.querySelector("#price");
			const $result = document
					.querySelector("#result")

				const price = value ? current * value : 0;
				const result = value ? balance - price
						: balance;
				$price.innerHTML = "&#8361;"
						+ price.toLocaleString();
				$result.innerHTML = "&#8361;"
						+ result.toLocaleString();

				$result.className = result < 0 ? "text-danger"
						: "";
		});
		

		document.addEventListener("DOMContentLoaded", function() {
			setInterval(drawChart, 10000);
			setInterval(updateLatestDataSet, 10000);
		});
	</script>
</body>
</html>